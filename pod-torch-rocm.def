Bootstrap: docker
From: rocm/pytorch:latest-base

%environment
export PATH=/usr/local/sbin:/usr/local/bin:$PATH
export LD_LIBRARY_PATH=/usr/local/lib64:/usr/local/lib:$LD_LIBRARY_PATH
export LC_ALL=C
export SCCACHE_MAX_FRAME_LENGTH=50000000
export SCCACHE_IDLE_TIMEOUT=0

%labels
AUTHOR Jianyu Mao

%post
    BUILD_DIR=/tmp/build    # temp build folder inside the container

    # apt install packages you need
    apt-get -y update
    apt-get -y install wget git bzip2 libjpeg-dev python3-dev

    # build environment
    mkdir -p $BUILD_DIR && cd $BUILD_DIR
    
    # conda
    conda config --file /.condarc --add channels defaults
    conda config --file /.condarc --add channels conda-forge
    conda update --yes conda

    # conda install packages you need, tqdm here as an example
    conda install --yes -c conda-forge tqdm
    
    # pip install packages you need
    pip3 install --upgrade pip

    # pytorch from source
    conda install astunparse numpy ninja pyyaml setuptools cmake cffi typing_extensions future six requests dataclasses mkl mkl-include
    cd ~
    git clone --recursive https://github.com/pytorch/pytorch
    cd pytorch
    #git submodule update --init -â€“recursive --jobs 0

    python3 tools/amd_build/build_amd.py
    echo "export CMAKE_PREFIX_PATH=${CONDA_PREFIX:-"$(dirname $(which conda))/../"}" >> $SINGULARITY_ENVIRONMENT
    USE_ROCM=1 MAX_JOBS=4 python3 setup.py install

    # cleanup
    cd /
    conda clean --index-cache --tarballs --packages --yes
    apt-get -y clean
    pip3 cache purge
    rm -rf $BUILD_DIR

# vim: syntax=sh:ts=4:sw=4:expandtab
